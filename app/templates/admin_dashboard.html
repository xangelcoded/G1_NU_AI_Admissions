<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>NU Quest â€¢ Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a122e" id="metaTheme"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Icons (Lucide) -->
  <script defer src="https://unpkg.com/lucide@latest"></script>

  <style>

:root{
  --radius-xxl:32px; --radius-xl:24px; --radius-lg:18px; --radius:12px; --radius-sm:10px;
  --ease-1:cubic-bezier(.2,.8,.2,1);
  --shadow-1:0 10px 22px hsl(231 64% 18%/.25), 0 4px 10px hsl(231 64% 10%/.30);
  --shadow-2:0 18px 42px hsl(231 64% 18%/.33), 0 6px 18px hsl(231 64% 10%/.22);
  --nu-blue:#0b3b8c; --nu-gold:#FFD86B; --nu-gold-2:#F5C94E; --nu-cyan:#34a3ff;
  --ink:hsl(231 22% 92%); --muted:hsl(231 14% 72%); --bg:hsl(231 66% 6%);
  --panel:hsl(231 60% 12%/.92); --panel-2:hsl(231 60% 10%/.9); --surface:hsl(231 60% 10%/.78);
  --glass:linear-gradient(180deg,hsl(231 60% 14%/.78),hsl(231 60% 10%/.72));
  --ring:hsl(47 98% 60%/.45); --border:1px solid hsl(0 0% 100%/.16); --border-strong:1px solid hsl(0 0% 100%/.24);
  --c1:#22c55e; --c2:#34a3ff; --c3:#f5a524; --c4:#ff6b6b; --c5:#94a3b8; --c6:#0b5bd5; --c7:#d4af37; --c8:#4f46e5; --c9:#06b6d4; --c10:#f97316;
}
[data-theme="light"]{
  --ink:hsl(233 28% 14%); --muted:hsl(233 12% 40%); --bg:hsl(225 35% 97%);
  --surface:hsl(0 0% 100%/.95); --panel:hsl(0 0% 100%/.98); --panel-2:#fff;
  --glass:linear-gradient(180deg,hsl(0 0% 100%/.88),hsl(0 0% 100%/.78));
  --ring:hsl(46 94% 50%/.30); --border:1px solid hsl(232 10% 10%/.10); --border-strong:1px solid hsl(232 10% 10%/.18);
  color-scheme:light;
}
:root,[data-theme="dark"]{ color-scheme:dark }

*{box-sizing:border-box}
html,body{height:100%}
html:focus-within{scroll-behavior:smooth}
body{
  margin:0; color:var(--ink);
  font:15px/1.55 Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  background:
    radial-gradient(110vmax 70vmax at 12% -10%, rgba(52,163,255,.22), transparent 60%),
    radial-gradient(120vmax 70vmax at 90% 0%, rgba(255,216,107,.18), transparent 50%),
    linear-gradient(180deg, hsl(231 65% 7%), hsl(231 60% 6%));
}
body::before, body::after{content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;}
body::before{
  background:
    repeating-linear-gradient(0deg, rgba(120,160,255,.08) 0 1px, transparent 1px 80px),
    repeating-linear-gradient(90deg, rgba(120,160,255,.08) 0 1px, transparent 1px 80px);
  mask:radial-gradient(110vmax 70vmax at 50% 50%, rgba(255,255,255,.7) 0%, rgba(255,255,255,.25) 60%, transparent 82%);
}
body::after{
  background:
    radial-gradient(60vmax 40vmax at 82% 10%, rgba(92,200,255,.12), transparent 60%),
    radial-gradient(90vmax 60vmax at 12% 96%, rgba(255,216,107,.10), transparent 70%);
}

/* Skip link */
.skip-link{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;}
.skip-link:focus{
  position:fixed; left:14px; top:10px; width:auto; height:auto; padding:10px 12px; z-index:200;
  background:var(--panel); border:var(--border-strong); border-radius:10px; font-weight:800;
}

/* ===== Header / Topbar ===== */
header.nav{position:sticky; top:0; z-index:120; padding:10px 14px; background:var(--glass); border-bottom:var(--border-strong); backdrop-filter:saturate(140%) blur(10px)}
.nav-inner{max-width:1280px; margin:0 auto; display:grid; gap:12px; grid-template-columns: 320px 1fr auto; align-items:center}
.brand-wrap{display:flex; align-items:center; gap:10px}
.crest{width:40px;height:40px;border-radius:14px;background:radial-gradient(55% 70% at 30% 30%, rgba(255,255,255,.75), transparent 60%), conic-gradient(from 210deg, #0b3b8c, #1a4fa1 60%, #0b3b8c); border:1px solid rgba(255,255,255,.2); box-shadow:0 1px 2px hsl(0 0% 0%/.45) inset}
.brand{display:flex; line-height:1.15}
.brand b{font:900 15px/1.1 Poppins,Inter,sans-serif; letter-spacing:.2px}
.brand small{color:var(--muted); font-weight:800}

.search-wrap{display:flex; align-items:center; gap:10px}
.search{display:flex; align-items:center; gap:8px; width:100%; padding:9px 12px; border-radius:12px; border:var(--border-strong); background:var(--panel); box-shadow:var(--shadow-1)}
.search input{all:unset; flex:1; font-weight:700; color:var(--ink)}
.nav-actions{display:flex; gap:8px; align-items:center}
.btn{display:inline-flex; align-items:center; gap:8px; cursor:pointer; padding:9px 11px; border-radius:12px; font-weight:800; color:var(--ink); background:var(--panel); border:var(--border-strong); box-shadow:var(--shadow-1); transition:transform .15s var(--ease-1), box-shadow .15s var(--ease-1)}
.btn.icon{padding:8px 10px; line-height:1}
.btn:hover{transform:translateY(-1px)}
.btn:focus-visible{outline:0; box-shadow:0 0 0 4px var(--ring), var(--shadow-1)}
.btn.primary{border:0; background:linear-gradient(180deg, var(--nu-gold), var(--nu-gold-2)); color:hsl(231 60% 8%); font-weight:900; box-shadow: 0 6px 22px rgba(255,216,107,.25), 0 2px 8px rgba(255,216,107,.15), 0 0 0 1px rgba(255,216,107,.28) inset}
.avatar{width:32px;height:32px;border-radius:50%; background:linear-gradient(180deg,#1a4fa1,#0b3b8c); border:1px solid hsl(0 0% 100%/.25)}
.net-dot{width:10px;height:10px;border-radius:50%; background:#22c55e; box-shadow:0 0 0 3px hsl(140 70% 40%/.2)}


/* Compact, wide status chip for the header toolbar */
.btn.status{
  padding: 6px 14px;      /* smaller vertical padding = less tall */
  line-height: 1;         /* tighten height */
  height: 32px;           /* hard cap height so it never gets tall */
  min-width: 300px;       /* make it look wider horizontally */
  white-space: nowrap;    /* keep on one line */
  display: inline-flex; 
  align-items: center; 
  justify-content: center;
  font-size: 12px;        /* optional: slightly smaller text */
}


#lastUpdated{
  padding: 6px 14px;
  line-height: 1;
  height: 32px;
  min-width: 300px;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

/* ===== Compact filter bar (12-col) ===== */
.toolbar{position:sticky; top:64px; z-index:110; border-bottom:var(--border); background:var(--panel-2); backdrop-filter:blur(6px)}
.toolbar .row{max-width:1280px; margin:0 auto; padding:8px 14px; display:grid; gap:8px; grid-template-columns: repeat(12, minmax(0,1fr)); align-items:center}
.toolbar label{grid-column: span 2 / span 2; font-size:12px; font-weight:900; color:var(--muted); display:flex; gap:6px; align-items:center}
.toolbar select{width:100%; padding:8px 10px; border-radius:10px; border:var(--border); background:var(--panel); color:var(--ink); font-weight:800}
.toolbar .actions{grid-column: span 2 / span 2; display:flex; gap:6px; justify-content:flex-end}
@media (max-width:1024px){ .toolbar label{grid-column: span 6 / span 6} .toolbar .actions{grid-column: span 6 / span 6} }

/* ===== Shell & grid ===== */
.container{max-width:1280px; margin:18px auto; padding:0 14px}
.page-head{display:grid; gap:10px; grid-template-columns:1fr auto; align-items:center; margin-bottom:10px}
.page-title{margin:0; font:900 26px/1.15 Poppins,Inter,sans-serif; letter-spacing:.2px}
.grid-2,.grid-3,.grid-4{display:grid; gap:12px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media (max-width:1100px){ .grid-4,.grid-3,.grid-2{grid-template-columns:1fr} }

/* ===== Cards ===== */
.card{position:relative; overflow:hidden; background:var(--panel); border-radius:var(--radius-xl); border:var(--border-strong); box-shadow:var(--shadow-1)}
.card h3{display:flex; align-items:center; gap:8px; margin:0; font:900 16px/1.2 Poppins,Inter,sans-serif}
.card .card-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:var(--border-strong); background:linear-gradient(180deg, rgba(52,163,255,.06), transparent)}
.card .card-body{ padding:14px }

/* Accent border */
.card::before{content:""; position:absolute; inset:-1px; border-radius:inherit; padding:1px; pointer-events:none; background:linear-gradient(90deg, rgba(52,163,255,.35), rgba(255,216,107,.35)); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude}

/* ===== KPIs ===== */
.kpi .kpi-num{font:900 clamp(22px,3vw,32px)/1 Poppins,Inter,sans-serif; color:var(--nu-gold)}
.kpi .spark{height:28px; width:100%; display:block}
.delta{font-size:12px; font-weight:900; padding:4px 8px; border-radius:999px; margin-left:6px; border:var(--border)}
.delta.up{background:rgba(34,197,94,.18); color:#22c55e}
.delta.down{background:rgba(255,107,107,.18); color:#ff7d7d}

/* ===== Charts ===== */
.chart{display:block; width:100%; height:360px; max-height:420px; border-radius:14px; background:var(--surface); border:var(--border-strong); position:relative; overflow:hidden}
.chart-tools{position:absolute; top:8px; right:8px; display:flex; gap:6px}
.chart-tools .btn{padding:6px 8px; font-size:12px}
canvas[data-chart]{display:block; width:100%; height:100%}
.skeleton{position:relative; overflow:hidden; background:linear-gradient(90deg,#111b36 25%,#0f172a 50%,#111b36 75%); background-size:200% 100%; animation:shim 1s linear infinite}
@keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}
.tabs{display:flex; gap:6px; flex-wrap:wrap; padding:8px 10px}
.tab{padding:8px 10px; border-radius:999px; border:var(--border); background:var(--panel); font-weight:900; cursor:pointer}
.tab[aria-selected="true"]{background:linear-gradient(90deg, rgba(52,163,255,.18), rgba(255,216,107,.18)); border-color:hsl(0 0% 100%/.28)}
.tabpanels > section{display:none}
.tabpanels > section[aria-hidden="false"]{display:block}

/* ===== Tables ===== */
.table-wrap{overflow:auto; max-height:520px}
table{width:100%; border-collapse:separate; border-spacing:0; background:var(--panel-2); border-radius:14px; border:var(--border-strong)}
th,td{white-space:nowrap; padding:12px 14px; border-bottom:1px solid hsl(231 30% 70%/.18); text-align:left; font-size:14px}
thead th{position:sticky; top:0; z-index:1; background:linear-gradient(180deg, rgba(52,163,255,.06), transparent); font-weight:900; border-bottom:2px solid hsl(0 0% 100%/.26)}
tbody td:first-child, thead th:first-child{position:sticky; left:0; z-index:2; background:inherit; border-right:1px solid hsl(0 0% 100%/.10)}
tbody tr:hover{ background:linear-gradient(90deg,rgba(255,216,107,.06),transparent) }
tr.row-vh{background:linear-gradient(90deg,rgba(34,197,94,.09),transparent)}
tr.row-h {background:linear-gradient(90deg,rgba(46,168,255,.09),transparent)}
tr.row-m {background:linear-gradient(90deg,rgba(125,185,255,.06),transparent)}
tr.row-l {background:linear-gradient(90deg,rgba(255,107,107,.10),transparent)}
tr.row-vl{background:linear-gradient(90deg,rgba(107,114,128,.10),transparent)}
.dense th,.dense td{padding:8px 10px}
.pager{display:flex; gap:.5rem; justify-content:flex-end; padding:8px 0}
.table-controls{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}

/* ===== Drawer & help & toasts ===== */
.drawer{position:fixed; top:0; right:-480px; width:480px; height:100dvh; background:var(--panel); border-left:var(--border-strong); box-shadow:var(--shadow-2); transition:right .25s var(--ease-1); z-index:160; display:flex; flex-direction:column}
.drawer.open{right:0}
.drawer header{padding:12px 14px; border-bottom:var(--border-strong); display:flex; align-items:center; justify-content:space-between}
.drawer .content{padding:14px; overflow:auto; display:flex; flex-direction:column; gap:10px}
.help{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:200}
.help.open{display:flex}
.help .box{background:var(--panel); border:var(--border-strong); padding:16px; border-radius:16px; width:min(92vw,720px); box-shadow:var(--shadow-2)}
.toasts{position:fixed; right:14px; bottom:14px; display:flex; flex-direction:column; gap:8px; z-index:220}
.toast{background:var(--panel); border:var(--border-strong); border-left:4px solid var(--nu-gold-2); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow-2)}
.sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

/* Motion & print */
@media (prefers-reduced-motion: reduce){
  * { animation-duration:.001ms !important; animation-iteration-count:1 !important; transition:none !important; }
}
@media print{
  header.nav, .toolbar, .toasts, .help { display:none !important }
  .container{max-width:none}
}
  </style>
</head>

<body>
<a href="#main" class="skip-link">Skip to content</a>

<!-- ===== NAVBAR ===== -->
<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-inner">
    <!-- Left: logo + product -->
    <div class="brand-wrap">
      <div class="crest" aria-hidden="true"></div>
      <div class="brand">
        <b>Smart Admission & Guidance Engine</b>
        <small>Admin Command Center</small>
      </div>
    </div>

    <!-- Center: global search -->
    <div class="search-wrap" role="search">
      <div class="search">
        <i data-lucide="search" aria-hidden="true"></i>
        <input id="globalSearch" type="search" placeholder="Search students, IDs, programsâ€¦" aria-label="Global search" />
      </div>
    </div>

    <!-- Right: notifications, avatar, theme, help -->
    <div class="nav-actions">
      <div id="netDot" class="net-dot" title="Network OK" aria-label="Network status"></div>
      <button id="themeBtn" class="btn icon" title="Toggle theme" aria-label="Toggle theme"><i data-lucide="moon-star"></i></button>
      <button id="helpBtn" class="btn icon" title="Keyboard shortcuts" aria-label="Keyboard shortcuts"><i data-lucide="keyboard"></i></button>
      <a class="btn icon" href="/logout" title="Logout" aria-label="Logout"><i data-lucide="log-out"></i></a>
      <button class="btn icon" title="Notifications" aria-label="Notifications"><i data-lucide="bell"></i></button>
      <div class="avatar" aria-label="User menu" title="User"></div>
    </div>
  </div>
</header>

<!-- ===== COMPACT FILTER BAR ===== -->
<div class="toolbar" role="region" aria-label="Quick filters">
  <div class="row">
    <label>Campus
      <select id="fCampus"><option value="">All</option></select>
    </label>
    <label>AY
      <select id="fAY">
        <option value="">All</option>
        <option>2023â€“2024</option>
        <option>2024â€“2025</option>
      </select>
    </label>
    <label>Term
      <select id="fTerm">
        <option value="">All</option>
        <option>1st</option>
        <option>2nd</option>
        <option>Summer</option>
      </select>
    </label>
    <label>Program
      <select id="fProgram"><option value="">All</option></select>
    </label>
    <label>Student Type
      <select id="fType">
        <option value="">All</option>
        <option value="full-time">Full-time</option>
        <option value="working-student">Working</option>
      </select>
    </label>
    <label>Min Conf
      <select id="fMinConf">
        <option value="0">0%</option>
        <option value="0.25">25%</option>
        <option value="0.5">50%</option>
        <option value="0.75">75%</option>
      </select>
    </label>
    <label>Lookback
      <select id="fDays">
        <option value="7">7d</option>
        <option value="14">14d</option>
        <option value="30" selected>30d</option>
        <option value="90">90d</option>
      </select>
    </label>
    <div class="actions">
      <button id="applyFilters" class="btn primary">Apply</button>
      <button id="resetFilters" class="btn" type="button">Reset</button>
      <span id="lastUpdated" class="btn status" style="pointer-events:none;" aria-live="polite">Loadingâ€¦</span>
    </div>
  </div>
</div>

<!-- ===== PAGE ===== -->
<main id="main" class="container" aria-live="polite">
  <div class="page-head">
    <h2 class="page-title">AI-Powered Enrollment Monitor</h2>
    <div class="table-controls">
      <label>Page Size
        <select id="tblSize"><option>25</option><option>50</option><option>100</option></select>
      </label>
      <label>Sort
        <select id="tblSort">
          <option value="priority">Priority</option>
          <option value="prob">Likelihood</option>
          <option value="conf">Confidence</option>
          <option value="created_at">Created</option>
        </select>
      </label>
      <label>Dir
        <select id="tblDir"><option value="desc">Desc</option><option value="asc">Asc</option></select>
      </label>
      <button id="tblApply" class="btn">Reload</button>
      <label class="btn" title="Dense rows"><input type="checkbox" id="denseRows"> Dense</label>
      <button id="exportClientCsv" class="btn">Export Visible CSV</button>
      <a id="exportCsv" class="btn" href="/api/admin/export.csv?days=30">Export CSV (server)</a>
    </div>
  </div>

  <!-- ===== KPIs ===== -->
  <section class="grid-4" aria-label="Key performance indicators">
    <div class="card kpi" style="box-shadow:var(--shadow-2)">
      <div class="card-head"><h3>Total Applicants</h3></div>
      <div class="card-body">
        <div style="display:flex; align-items:center; gap:8px">
          <div id="kpiTotal" class="kpi-num">â€”</div>
          <span id="kpiTotalDelta" class="delta" style="display:none">0%</span>
        </div>
        <small id="kpiTotalHint" class="muted"></small>
      </div>
    </div>
    <div class="card kpi">
      <div class="card-head"><h3>Enrollment Likelihood (avg)</h3></div>
      <div class="card-body">
        <div style="display:flex; align-items:center; gap:8px">
          <div id="kpiAvgProb" class="kpi-num">â€”</div>
          <span id="kpiProbDelta" class="delta" style="display:none">0%</span>
        </div>
        <canvas id="sparkProb" class="spark" aria-hidden="true"></canvas>
      </div>
    </div>
    <div class="card kpi">
      <div class="card-head"><h3>Re-enrollment Likelihood (avg)</h3></div>
      <div class="card-body">
        <div style="display:flex; align-items:center; gap:8px">
          <div id="kpiAvgConf" class="kpi-num">â€”</div>
          <span id="kpiConfDelta" class="delta" style="display:none">0%</span>
        </div>
        <canvas id="sparkConf" class="spark" aria-hidden="true"></canvas>
      </div>
    </div>
    <div class="card kpi">
      <div class="card-head"><h3>At-Risk Students</h3></div>
      <div class="card-body">
        <div id="kpiBuckets5" class="kpi-num">â€”</div>
        <small class="muted">VH / H / M / L / VL</small>
      </div>
    </div>
  </section>

  <!-- ===== Analytics (Tabbed) ===== -->
  <section class="card" aria-label="Analytics">
    <div class="card-head">
      <h3>Analytics</h3>
      <div class="tabs" role="tablist" aria-label="Chart groups">
        <button class="tab" role="tab" id="tab-comp" aria-controls="panel-comp" aria-selected="true">Composition</button>
        <button class="tab" role="tab" id="tab-dist" aria-controls="panel-dist" aria-selected="false">Distribution</button>
        <button class="tab" role="tab" id="tab-hist" aria-controls="panel-hist" aria-selected="false">Histograms</button>
        <button class="tab" role="tab" id="tab-trend" aria-controls="panel-trend" aria-selected="false">Trends</button>
        <button class="tab" role="tab" id="tab-heat" aria-controls="panel-heat" aria-selected="false">Heatmap</button>
        <button class="tab" role="tab" id="tab-scatter" aria-controls="panel-scatter" aria-selected="false">Priority</button>
      </div>
    </div>
    <div class="card-body tabpanels">
      <!-- Composition -->
      <section id="panel-comp" role="tabpanel" aria-labelledby="tab-comp" aria-hidden="false">
        <div class="grid-2">
          <div class="card">
            <div class="card-head">
              <div><h3>Bucket Share</h3><span class="muted" id="sumBuckets">Share of all applicants</span></div>
              <div class="chart-tools"><button class="btn" data-dl="#chartBuckets5">Download</button></div>
            </div>
            <div class="card-body">
              <div class="chart"><canvas id="chartBuckets5" data-chart class="skeleton" aria-label="Bucket share"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-head">
              <div><h3>Program Popularity</h3><span class="muted" id="sumPrograms">Top programs</span></div>
              <div class="chart-tools"><button class="btn" data-dl="#chartPrograms">Download</button></div>
            </div>
            <div class="card-body">
              <div class="chart"><canvas id="chartPrograms" data-chart class="skeleton" aria-label="Programs"></canvas></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Distribution -->
      <section id="panel-dist" role="tabpanel" aria-labelledby="tab-dist" aria-hidden="true">
        <div class="grid-2">
          <div class="card">
            <div class="card-head">
              <div><h3>Campus / Region Distribution</h3><span class="muted" id="sumRegions">Applicants by campus/region</span></div>
              <div class="chart-tools"><button class="btn" data-dl="#chartRegions">Download</button></div>
            </div>
            <div class="card-body">
              <div class="chart"><canvas id="chartRegions" data-chart class="skeleton" aria-label="Regions"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-head">
              <div><h3>Student Type Split</h3><span class="muted" id="sumTypes">Full-time vs Working</span></div>
              <div class="chart-tools"><button class="btn" data-dl="#chartStudentType">Download</button></div>
            </div>
            <div class="card-body">
              <div class="chart"><canvas id="chartStudentType" data-chart class="skeleton" aria-label="Student type"></canvas></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Histograms -->
      <section id="panel-hist" role="tabpanel" aria-labelledby="tab-hist" aria-hidden="true">
        <div class="grid-2">
          <div class="card">
            <div class="card-head">
              <div><h3>Likelihood Histogram</h3><span class="muted">L2E%</span></div>
              <div class="chart-tools"><button class="btn" data-dl="#chartHistProb">Download</button></div>
            </div>
            <div class="card-body">
              <div class="chart"><canvas id="chartHistProb" data-chart class="skeleton" aria-label="Likelihood histogram"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-head">
              <div><h3>Confidence Histogram</h3><span class="muted">Confidence%</span></div>
              <div class="chart-tools"><button class="btn" data-dl="#chartHistConf">Download</button></div>
            </div>
            <div class="card-body">
              <div class="chart"><canvas id="chartHistConf" data-chart class="skeleton" aria-label="Confidence histogram"></canvas></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Trends -->
      <section id="panel-trend" role="tabpanel" aria-labelledby="tab-trend" aria-hidden="true">
        <div class="card">
          <div class="card-head">
            <div><h3>Trends Over Terms</h3><span class="muted">Avg Likelihood & Confidence</span></div>
            <div class="chart-tools"><button class="btn" data-dl="#chartTrend">Download</button></div>
          </div>
          <div class="card-body">
            <div class="chart"><canvas id="chartTrend" data-chart class="skeleton" aria-label="Trend line"></canvas></div>
          </div>
        </div>
      </section>

      <!-- Heatmap -->
      <section id="panel-heat" role="tabpanel" aria-labelledby="tab-heat" aria-hidden="true">
        <div class="card">
          <div class="card-head">
            <div><h3>Likelihood Ã— Confidence Heatmap</h3><span class="muted">Concentration</span></div>
            <div class="chart-tools"><button class="btn" data-dl="#chartHeat">Download</button></div>
          </div>
          <div class="card-body">
            <div class="chart"><canvas id="chartHeat" data-chart class="skeleton" aria-label="Heatmap"></canvas></div>
          </div>
        </div>
      </section>

      <!-- Priority Scatter -->
      <section id="panel-scatter" role="tabpanel" aria-labelledby="tab-scatter" aria-hidden="true">
        <div class="card">
          <div class="card-head">
            <div><h3>Priority Quadrant</h3><span class="muted">L2E% vs Confidence%</span></div>
            <div class="chart-tools"><button class="btn" data-dl="#chartScatter">Download</button></div>
          </div>
          <div class="card-body">
            <div class="chart"><canvas id="chartScatter" data-chart class="skeleton" aria-label="Priority scatter"></canvas></div>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- ===== Applicants / Top At-Risk ===== -->
  <section class="card" aria-label="Applicants worklist">
    <div class="card-head">
      <h3>Top At-Risk Students</h3>
      <div class="table-controls">
        <span id="tblMeta" class="muted"></span>
      </div>
    </div>
    <div class="card-body">
      <div class="table-wrap" id="tableWrap">
        <table class="table" id="topTable" aria-label="Top At-Risk Students table">
          <thead>
            <tr>
              <th>Bucket</th>
              <th title="Priority = Likelihood Ã— Confidence">Priority</th>
              <th>Likelihood</th>
              <th>Confidence</th>
              <th>Program</th>
              <th>Student Type</th>
              <th>Region</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody><!-- rows injected --></tbody>
        </table>
      </div>
      <div class="pager" aria-label="Pagination">
        <button id="prevPage" class="btn" aria-label="Previous page">Prev</button>
        <span id="pageInfo" aria-live="polite"></span>
        <button id="nextPage" class="btn" aria-label="Next page">Next</button>
      </div>
    </div>
  </section>

  <!-- ===== Recent Registrations ===== -->
  <section class="card" aria-label="Recent registrations">
    <div class="card-head">
      <h3>Recent Registrations</h3>
      <small class="muted">Newest records by Created date</small>
    </div>
    <div class="card-body">
      <div class="table-wrap" style="max-height:320px">
        <table class="table" id="recentTable" aria-label="Recent Registrations table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Program</th>
              <th>Student Type</th>
              <th>Region</th>
              <th>Likelihood</th>
              <th>Confidence</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody><!-- recent rows injected --></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- ===== Drawer ===== -->
<aside class="drawer" id="drawer" aria-modal="true" aria-labelledby="drawerTitle" role="dialog">
  <header>
    <strong id="drawerTitle">Applicant Details</strong>
    <button id="drawerClose" class="btn" aria-label="Close details">Close</button>
  </header>
  <div class="content" id="drawerContent">
    <div class="muted">Select a row to view details (if backend returns <code>id</code>).</div>
  </div>
</aside>

<!-- ===== Help ===== -->
<div id="help" class="help" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="box">
    <h3 id="helpTitle" style="margin-top:0">Keyboard Shortcuts</h3>
    <ul style="line-height:1.8; margin:0 0 12px 16px">
      <li><strong>/</strong> â€“ Focus global search</li>
      <li><strong>r</strong> â€“ Refresh data</li>
      <li><strong>[</strong> / <strong>]</strong> â€“ Prev / Next page</li>
      <li><strong>g g</strong> â€“ Scroll to top</li>
      <li><strong>âŒ˜/Ctrl + K</strong> â€“ Command palette</li>
      <li><strong>?</strong> â€“ Toggle this help</li>
    </ul>
    <div style="display:flex;justify-content:flex-end"><button id="helpClose" class="btn">Close</button></div>
  </div>
</div>

<!-- Toasts & live region -->
<div class="toasts" id="toasts" aria-live="polite"></div>
<div id="a11yLive" class="sr-only" aria-live="polite"></div>

<script>
/* ======= CONFIG ======= */
/** Same-origin by default. If your JSON lives elsewhere, set a base like:
 *  const BACKEND_BASE = "https://your-api.tld";
 */
const BACKEND_BASE = ""; // do not change server routes; just prefix if deploying behind a different host

/* ======= Icons (Lucide) ======= */
document.addEventListener('DOMContentLoaded', () => { try { lucide.createIcons(); } catch {} });

/* ======= Theme ======= */
(function(){
  const KEY='sage_theme_mode';
  const root=document.body;
  const meta=document.getElementById('metaTheme');
  const apply=(mode)=>{
    const final=(mode==='auto') ? (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light') : mode;
    root.setAttribute('data-theme', final);
    document.documentElement.style.colorScheme = final;
    meta?.setAttribute('content', final==='dark' ? '#0a122e' : '#ffffff');
  };
  const saved = ['auto','light','dark'].includes(localStorage.getItem(KEY)) ? localStorage.getItem(KEY) : 'dark';
  apply(saved);
  document.getElementById('themeBtn')?.addEventListener('click', ()=>{
    const cur=localStorage.getItem(KEY)||saved;
    const next=cur==='dark'?'light':'dark';
    localStorage.setItem(KEY,next); apply(next); toast('Theme: '+next);
  });
})();

/* ======= Utils ======= */
const byId = id => document.getElementById(id);
const pct  = x => (x*100).toFixed(1)+'%';
const titleize = s => (s||'').replace(/\b\w/g,c=>c.toUpperCase());
const fmtDate  = s => { try{ return new Date(s).toLocaleString(); }catch{ return s||''; } };
const announce = (msg)=>{ const el=byId('a11yLive'); el.textContent=''; setTimeout(()=>el.textContent=msg, 20); };
function toast(msg, ms=3000){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; byId('toasts').appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .2s'; setTimeout(()=>t.remove(),200); }, ms); }
function fullUrl(path){ const base = BACKEND_BASE.replace(/\/$/,''); return base + path; }

let metricsCtrl=null, tableCtrl=null, recentCtrl=null;
async function getJSON(url, kind='metrics'){
  if (kind==='metrics' && metricsCtrl){ metricsCtrl.abort(); }
  if (kind==='table'   && tableCtrl){   tableCtrl.abort(); }
  if (kind==='recent'  && recentCtrl){  recentCtrl.abort(); }
  const ctrl = new AbortController();
  if (kind==='metrics') metricsCtrl=ctrl; else if (kind==='table') tableCtrl=ctrl; else recentCtrl=ctrl;
  const r = await fetch(url, { signal: ctrl.signal, credentials: (BACKEND_BASE && BACKEND_BASE.startsWith('http')) ? 'include' : 'same-origin', headers: { 'Accept':'application/json' } });
  if (r.status===401 || r.status===403){ window.location.href='/login'; return {ok:false}; }
  if (!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

/* ======= Charts (Canvas) ======= */
const COLORS=['#22c55e','#34a3ff','#f5a524','#ff6b6b','#94a3b8','#0b5bd5','#d4af37','#4f46e5','#06b6d4','#f97316'];
const dpr = () => window.devicePixelRatio || 1;
function prepCanvas(canvas){
  const rect = canvas.getBoundingClientRect();
  const W = Math.max(10, Math.floor(rect.width));
  const H = Math.max(10, Math.floor(rect.height));
  const R = dpr();
  if (canvas.__w!==W || canvas.__h!==H || canvas.__r!==R){
    canvas.width  = Math.round(W * R);
    canvas.height = Math.round(H * R);
    canvas.__w=W; canvas.__h=H; canvas.__r=R;
  }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(R,0,0,R,0,0);
  ctx.clearRect(0,0,W,H);
  return {ctx,w:W,h:H};
}
function legend(ctx, labels, x=12, y=12){
  ctx.font='12px Inter, system-ui, sans-serif';
  labels.forEach((t,i)=>{ ctx.fillStyle = COLORS[i%COLORS.length]; ctx.fillRect(x, y+i*20, 14, 14);
    ctx.fillStyle = '#c8d6ff'; ctx.fillText(t, x+20, y+12+i*20); });
}
const Charts={
  stacked100(c, vals, labels){
    const {ctx,w,h}=prepCanvas(c); c.classList.remove('skeleton');
    const total = Math.max(1, vals.reduce((a,b)=>a+b,0));
    const L=16,R=16,T=24,B=28, W=w-L-R, H=h-T-B;
    ctx.strokeStyle='rgba(200,210,240,.25)'; ctx.beginPath(); ctx.moveTo(L,T+H); ctx.lineTo(L+W,T+H); ctx.stroke();
    let x=L;
    vals.forEach((v,i)=>{ const px=(v/total)*W; ctx.fillStyle=COLORS[i%COLORS.length]; ctx.fillRect(x, T+H*0.25, px, H*0.5); x+=px; });
    x=L; ctx.fillStyle='#c8d6ff'; ctx.font='12px Inter, system-ui';
    vals.forEach((v)=>{ const px=(v/total)*W; const t= ((v/total)*100).toFixed(0)+'%'; if(px>34){ ctx.fillText(t, x+px/2-10, T+H*0.25-6); } x+=px; });
    legend(ctx, labels);
  },
  barsH(c, labels, values){
    const {ctx,w,h}=prepCanvas(c); c.classList.remove('skeleton');
    const max=Math.max(1,...values); const L=160,R=16,T=18,B=22; const W=w-L-R,H=h-T-B; const row=H/Math.max(1,labels.length);
    ctx.font='12px Inter, system-ui';
    labels.forEach((lab,i)=>{ const y=T+i*row+row*0.15; ctx.fillStyle='#95a2c4'; ctx.fillText(lab,8,y+12);
      const bw=(values[i]/max)*W; ctx.fillStyle=COLORS[i%COLORS.length]; ctx.fillRect(L,y,bw,row*0.7); });
    ctx.strokeStyle='rgba(200,210,240,.25)'; ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,T+H); ctx.stroke();
  },
  pie(c, vals, labels){
    const {ctx,w,h}=prepCanvas(c); c.classList.remove('skeleton');
    const total=vals.reduce((a,b)=>a+b,0)||1; let s=-Math.PI/2; const cx=w/2,cy=h/2,r=Math.min(w,h)*0.44;
    vals.forEach((v,i)=>{ const ang=(v/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=COLORS[i%COLORS.length]; ctx.arc(cx,cy,r,s,s+ang); ctx.fill(); s+=ang; });
    legend(ctx, labels);
  },
  hist(c, bins, colorIdx=6, label=''){
    const {ctx,w,h}=prepCanvas(c); c.classList.remove('skeleton');
    const L=40,R=16,T=16,B=28, W=w-L-R,H=h-T-B, max=Math.max(1,...bins), bw=W/Math.max(1,bins.length);
    ctx.fillStyle=COLORS[colorIdx%COLORS.length];
    bins.forEach((v,i)=>{ const bh=(v/max)*H; ctx.fillRect(L+i*bw,T+(H-bh),bw*0.9,bh); });
    ctx.strokeStyle='rgba(200,210,240,.25)'; ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,T+H); ctx.lineTo(L+W,T+H); ctx.stroke();
    if(label){ ctx.fillStyle='#95a2c4'; ctx.font='12px Inter, system-ui'; ctx.fillText(label, L+6, T+14); }
  },
  line2(c, labels, s1, s2, n1='Likelihood %', n2='Confidence %'){
    const {ctx,w,h}=prepCanvas(c); c.classList.remove('skeleton');
    const L=40,R=40,T=18,B=24, W=w-L-R,H=h-T-B;
    ctx.strokeStyle='rgba(200,210,240,.25)'; ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,T+H); ctx.lineTo(L+W,T+H); ctx.stroke();
    const plot=(data,col)=>{ ctx.beginPath(); ctx.strokeStyle=col; ctx.lineWidth=2;
      data.forEach((v,i)=>{ const x=L+(i/Math.max(1,data.length-1))*W; const y=T+(1-(v-0)/(100-0))*H; i?ctx.lineTo(x,y):ctx.moveTo(x,y); }); ctx.stroke(); };
    plot(s1, COLORS[0]); plot(s2, COLORS[3]);
    ctx.font='11px Inter, system-ui'; ctx.fillStyle='#95a2c4'; ctx.textAlign='center';
    const step=Math.max(1,Math.ceil(labels.length/8));
    labels.forEach((lb,i)=>{ if(i%step===0){ const x=L+(i/(labels.length-1))*W; ctx.fillText(lb, x, h-6); }});
    ctx.fillStyle=COLORS[0]; ctx.fillRect(w-150,10,12,12); ctx.fillStyle='#c8d6ff'; ctx.fillText(n1, w-130, 20);
    ctx.fillStyle=COLORS[3]; ctx.fillRect(w-150,28,12,12); ctx.fillStyle='#c8d6ff'; ctx.fillText(n2, w-130, 38);
  },
  scatter(c, pts){
    const {ctx,w,h}=prepCanvas(c); c.classList.remove('skeleton');
    const L=40,R=16,T=16,B=28,W=w-L-R,H=h-T-B;
    ctx.strokeStyle='rgba(200,210,240,.25)'; ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,T+H); ctx.lineTo(L+W,T+H); ctx.stroke();
    ctx.fillStyle=COLORS[1];
    pts.forEach(p=>{ const x=L+(p.x/100)*W; const y=T+(1-p.y/100)*H; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
  },
  bubbles(c, pts){
    const {ctx,w,h}=prepCanvas(c); c.classList.remove('skeleton');
    const L=40,R=16,T=16,B=28,W=w-L-R,H=h-T-B;
    ctx.strokeStyle='rgba(200,210,240,.25)'; ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,T+H); ctx.lineTo(L+W,T+H); ctx.stroke();
    pts.forEach((p,i)=>{ const x=L+(p.x/100)*W; const y=T+(1-p.y/100)*H; const r=Math.max(2, Math.sqrt((p.count||1))*2);
      ctx.beginPath(); ctx.fillStyle = COLORS[i%COLORS.length] + '88'; ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); });
  },
  spark(c, values, colorIdx=0){
    const {ctx,w,h}=prepCanvas(c);
    const min=Math.min(...values,0), max=Math.max(...values,1);
    ctx.beginPath(); ctx.strokeStyle=COLORS[colorIdx%COLORS.length]; ctx.lineWidth=2;
    values.forEach((v,i)=>{ const x=(i/(Math.max(1,values.length-1)))*w; const y=h-(v-min)/(max-min)*h; i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.stroke();
  }
};

/* ======= State refs ======= */
const kpiTotal=byId('kpiTotal'), kpiTotalHint=byId('kpiTotalHint');
const kpiAvgProb=byId('kpiAvgProb'), kpiAvgConf=byId('kpiAvgConf'), kpiBuckets5=byId('kpiBuckets5');
const kpiProbDelta=byId('kpiProbDelta'), kpiConfDelta=byId('kpiConfDelta'), kpiTotalDelta=byId('kpiTotalDelta');
const sparkProb=byId('sparkProb'), sparkConf=byId('sparkConf');
const lastUpdated=byId('lastUpdated');

const tblBody = document.querySelector('#topTable tbody');
const tblSort=byId('tblSort'), tblDir=byId('tblDir'), tblSize=byId('tblSize');
const prevPage=byId('prevPage'), nextPage=byId('nextPage'), pageInfo=byId('pageInfo'), tblMeta=byId('tblMeta');

const recentBody = document.querySelector('#recentTable tbody');

const fCampus=byId('fCampus'), fAY=byId('fAY'), fTerm=byId('fTerm'), fProgram=byId('fProgram'), fType=byId('fType'), fMinConf=byId('fMinConf'), fDays=byId('fDays');

let thresholds={high:0.75, medium:0.5};
let page=1, total=0, lastMetrics=null, latestRows=[];

/* ======= Filters + URLs ======= */
function readFilters(){
  return {
    region: fCampus.value||'',
    program: fProgram.value||'',
    type: fType.value||'',
    min_conf: fMinConf.value||'0',
    days: fDays.value||'30',
    sort: tblSort.value||'priority',
    dir: tblDir.value||'desc',
    page_size: tblSize.value||'25'
  };
}
function buildQS(base){
  const f=readFilters();
  const qs=new URLSearchParams({ days:f.days, min_conf:f.min_conf, sort:f.sort, dir:f.dir, page_size:f.page_size });
  if (f.program) qs.set('program', f.program);
  if (f.region)  qs.set('region', f.region);
  return fullUrl(base)+'?'+qs.toString();
}

/* ======= Deltas & buckets ======= */
const DEFAULT_THRESH={ very_high:0.90, high:0.75, medium:0.50, low:0.25 };
function setDelta(el, prev, curr){
  if (prev==null || curr==null) { el.style.display='none'; return; }
  const diff=(curr-prev); if (Math.abs(diff)<1e-6){ el.style.display='none'; return; }
  const pctDiff=(prev===0?0:(diff/prev*100));
  el.textContent=(pctDiff>0?'â–² ':'â–¼ ')+Math.abs(pctDiff).toFixed(1)+'%';
  el.className='delta '+(pctDiff>=0?'up':'down'); el.style.display='';
}
function bucketOf(prob){
  const t = { vh:DEFAULT_THRESH.very_high, h:thresholds.high||DEFAULT_THRESH.high, m:thresholds.medium||DEFAULT_THRESH.medium, l:DEFAULT_THRESH.low };
  if (prob>=t.vh) return {key:'VH',label:'Very High',class:'badge-vh'};
  if (prob>=t.h)  return {key:'H', label:'High',     class:'badge-h'};
  if (prob>=t.m)  return {key:'M', label:'Medium',   class:'badge-m'};
  if (prob>=t.l)  return {key:'L', label:'Low',      class:'badge-l'};
  return {key:'VL',label:'Very Low',class:'badge-vl'};
}

/* ======= Charts + KPIs ======= */
function drawCharts(m){
  const counts5={VH:0,H:0,M:0,L:0,VL:0};
  (m.top||[]).forEach(r=>counts5[bucketOf(r.prob||0).key]++);
  if ((m.top||[]).length<10){
    counts5.H=m.summary.high||0; counts5.M=m.summary.med||0; counts5.L=m.summary.low||0;
    counts5.VH=Math.round(counts5.H*0.3); counts5.H=Math.max(0,counts5.H-counts5.VH);
    counts5.VL=Math.round(counts5.L*0.3); counts5.L=Math.max(0,counts5.L-counts5.VL);
  }
  const bucketVals=[counts5.VH,counts5.H,counts5.M,counts5.L,counts5.VL];
  const bucketLabs=['Very High','High','Medium','Low','Very Low'];
  const totalBucket = bucketVals.reduce((a,b)=>a+b,0);
  byId('sumBuckets').textContent = totalBucket ? `VH ${counts5.VH} â€¢ H ${counts5.H} â€¢ M ${counts5.M} â€¢ L ${counts5.L} â€¢ VL ${counts5.VL}` : 'No data';

  Charts.stacked100(byId('chartBuckets5'), bucketVals, bucketLabs);
  Charts.barsH(byId('chartPrograms'), (m.programs||[]).map(p=>titleize(p.program)), (m.programs||[]).map(p=>p.count));
  Charts.barsH(byId('chartRegions'),  (m.regions||[]).map(r=>titleize(r.region)), (m.regions||[]).map(r=>r.count));
  byId('sumPrograms').textContent = (m.programs?.length?`Top ${Math.min(m.programs.length,10)} programs`:'No data');
  byId('sumRegions').textContent  = (m.regions?.length?`${m.regions.length} regions`:'No data');

  Charts.pie(byId('chartStudentType'), (m.student_type||[]).map(x=>x.count), (m.student_type||[]).map(x=>titleize(x.type)));
  byId('sumTypes').textContent = (m.student_type?.length?m.student_type.map(x=>`${titleize(x.type)}: ${x.count}`).join(' â€¢ '):'No data');

  Charts.hist(byId('chartHistProb'), (m.hist_prob||[]).map(x=>x||0), 6, 'Likelihood');
  Charts.hist(byId('chartHistConf'), (m.hist_conf||[]).map(x=>x||0), 1, 'Confidence');

  const pSeries=(m.trend||[]).map(t=>Number((t.avg_prob||0)*100));
  const cSeries=(m.trend||[]).map(t=>Number((t.avg_conf||0)*100));
  Charts.line2(byId('chartTrend'), (m.trend||[]).map(t=>t.date), pSeries, cSeries);
  Charts.bubbles(byId('chartHeat'), (m.heat||[]).map(pt=>({x:pt.x,y:pt.y,count:pt.count||1})));
  Charts.scatter(byId('chartScatter'), (m.top||[]).map(r=>({x:Number((r.prob||0)*100), y:Number((r.conf||0)*100)})));
}

function drawAll(m){
  thresholds=m.thresholds||thresholds;

  // Program/Campus tokens for filters
  fProgram.innerHTML='<option value="">All</option>' + (m.program_tokens||[]).map(p=>`<option value="${p}">${titleize(p)}</option>`).join('');
  fCampus.innerHTML ='<option value="">All</option>' + (m.region_tokens ||[]).map(r=>`<option value="${r}">${titleize(r)}</option>`).join('');

  // KPIs
  const n=m.summary.n||0;
  kpiTotal.textContent=String(n);
  kpiTotalHint.textContent=(m.summary.n_recent ? `${m.summary.n_recent} in last ${readFilters().days}d` : '');
  kpiAvgProb.textContent=pct(m.summary.avg_prob||0);
  kpiAvgConf.textContent=pct(m.summary.avg_conf||0);

  const counts5={VH:0,H:0,M:0,L:0,VL:0};
  (m.top||[]).forEach(r=>counts5[bucketOf(r.prob||0).key]++);
  if ((m.top||[]).length<10){
    counts5.H=m.summary.high||0; counts5.M=m.summary.med||0; counts5.L=m.summary.low||0;
    counts5.VH=Math.round(counts5.H*0.3); counts5.H=Math.max(0,counts5.H-counts5.VH);
    counts5.VL=Math.round(counts5.L*0.3); counts5.L=Math.max(0,counts5.L-counts5.VL);
  }
  kpiBuckets5.textContent=`${counts5.VH} / ${counts5.H} / ${counts5.M} / ${counts5.L} / ${counts5.VL}`;

  const last2=(m.trend||[]).slice(-2);
  if(last2.length===2){
    setDelta(kpiProbDelta, (last2[0].avg_prob||0), (last2[1].avg_prob||0));
    setDelta(kpiConfDelta, (last2[0].avg_conf||0), (last2[1].avg_conf||0));
    setDelta(kpiTotalDelta, (last2[0].count||0), (last2[1].count||0));
  } else { kpiProbDelta.style.display='none'; kpiConfDelta.style.display='none'; kpiTotalDelta.style.display='none'; }

  // Sparklines
  const pSeries=(m.trend||[]).map(t=>Number((t.avg_prob||0)*100));
  const cSeries=(m.trend||[]).map(t=>Number((t.avg_conf||0)*100));
  if(pSeries.length) Charts.spark(sparkProb, pSeries, 0);
  if(cSeries.length) Charts.spark(sparkConf, cSeries, 3);

  // Charts
  drawCharts(m);
}

/* ======= Main Table ======= */
function applyClientSearch(rows){
  const q=(byId('globalSearch').value||'').trim().toLowerCase(); if(!q) return rows;
  const tokens=q.split(/\s+/);
  return rows.filter(r=>{
    const hay=[r.id, r.first_program, r.curr_region, r.student_type].map(x=>(x||'').toString().toLowerCase()).join(' ');
    return tokens.every(t=> hay.includes(t));
  });
}
async function loadTable(){
  const f=readFilters();
  const qs=new URLSearchParams({
    days:f.days, page:String(page), page_size:String(f.page_size),
    sort:f.sort, dir:f.dir, min_conf:f.min_conf
  });
  if (f.program) qs.set('program', f.program);
  if (f.region)  qs.set('region', f.region);

  try{
    const res=await getJSON(fullUrl('/api/admin/table?'+qs.toString()), 'table');
    if(!res.ok) return;
    total=res.total||0; const size=Number(f.page_size||25);
    const pages=Math.max(1, Math.ceil(total/size));
    pageInfo.textContent='Page '+res.page+' of '+pages; tblMeta.textContent=total+' records';
    latestRows=applyClientSearch(res.rows||[]); renderTable(latestRows);
  }catch{ toast('Table failed to load', 3500); }
}
function renderTable(rows){
  tblBody.innerHTML='';
  if(!rows.length){
    const tr=document.createElement('tr'); tr.innerHTML='<td colspan="8" class="muted">No records for filters.</td>'; tblBody.appendChild(tr); return;
  }
  rows.forEach(r=>{
    const b=bucketOf(r.prob||0); const tr=document.createElement('tr'); tr.className='row-'+b.key.toLowerCase();
    tr.innerHTML=`
      <td><span class="badge ${b.class}">${b.label}</span></td>
      <td><strong>${pct(r.priority||0)}</strong></td>
      <td>${pct(r.prob||0)}</td>
      <td>${pct(r.conf||0)}</td>
      <td>${titleize(r.first_program||'')}</td>
      <td>${titleize(r.student_type||'')}</td>
      <td>${titleize(r.curr_region||'')}</td>
      <td>${fmtDate(r.created_at)}</td>`;
    if (r.id){ tr.style.cursor='pointer'; tr.title='Open details'; tr.addEventListener('click', ()=> openDrawer(r)); }
    tblBody.appendChild(tr);
  });
}

/* ======= Recent Registrations mini-table (no new endpoint; reuse /table) ======= */
async function loadRecent(){
  const f=readFilters();
  const qs=new URLSearchParams({
    days:f.days, page:String(1), page_size:String(10),
    sort:'created_at', dir:'desc', min_conf:f.min_conf
  });
  if (f.program) qs.set('program', f.program);
  if (f.region)  qs.set('region', f.region);
  try{
    const res=await getJSON(fullUrl('/api/admin/table?'+qs.toString()), 'recent');
    renderRecent(res.rows||[]);
  }catch{ renderRecent([]); }
}
function renderRecent(rows){
  recentBody.innerHTML='';
  if(!rows.length){ recentBody.innerHTML='<tr><td colspan="7" class="muted">No recent records.</td></tr>'; return; }
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.id ?? '-'}</td>
      <td>${titleize(r.first_program||'')}</td>
      <td>${titleize(r.student_type||'')}</td>
      <td>${titleize(r.curr_region||'')}</td>
      <td>${pct(r.prob||0)}</td>
      <td>${pct(r.conf||0)}</td>
      <td>${fmtDate(r.created_at)}</td>`;
    if (r.id){ tr.style.cursor='pointer'; tr.title='Open details'; tr.addEventListener('click', ()=> openDrawer(r)); }
    recentBody.appendChild(tr);
  });
}

/* ======= Drawer ======= */
const drawer=byId('drawer'), drawerClose=byId('drawerClose'), drawerContent=byId('drawerContent'); let lastFocused=null;
function openDrawer(row){
  lastFocused=document.activeElement;
  drawerContent.innerHTML='<div class="muted">Loadingâ€¦</div>';
  drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
  drawerClose.focus();
  if (!row.id){ drawerContent.innerHTML = '<div class="muted">No ID provided by backend for this row.</div>'; return; }
  getJSON(fullUrl('/api/admin/record/'+encodeURIComponent(row.id)),'metrics')
    .then((data)=>{
      if(!data.ok){ drawerContent.innerHTML='<div class="muted">No details available.</div>'; return; }
      const r = data.record || row;
      drawerContent.innerHTML = `
        <div style="font-weight:800;font-size:16px">${titleize(r.first_program||'')}</div>
        <div class="muted">Applicant ID: ${r.id||'-'}</div>
        <hr style="border:none;border-top:1px dashed rgba(200,210,240,.25)">
        <div><b>Likelihood:</b> ${pct(r.prob||0)}</div>
        <div><b>Confidence:</b> ${pct(r.conf||0)}</div>
        <div><b>Priority:</b> ${pct((r.prob||0)*(r.conf||0))}</div>
        <div><b>Student Type:</b> ${titleize(r.student_type||'')}</div>
        <div><b>Region:</b> ${titleize(r.curr_region||'')}</div>
        <div><b>Created:</b> ${fmtDate(r.created_at)}</div>
        ${r.lime_html ? `<hr><div><b>Why (LIME):</b></div><div>${r.lime_html}</div>` : ''}`;
    }).catch(()=>{ drawerContent.innerHTML='<div class="muted">Failed to load details.</div>'; });
}
function closeDrawer(){
  drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true');
  if (lastFocused && lastFocused.focus) { lastFocused.focus(); }
}
drawerClose.addEventListener('click', closeDrawer);
drawer.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

/* ======= Tabs + Resize Replot ======= */
(function(){
  const tabs=[...document.querySelectorAll('.tab[role="tab"]')];
  const panels=[...document.querySelectorAll('.tabpanels > section[role="tabpanel"]')];
  function show(id){
    tabs.forEach(t=> t.setAttribute('aria-selected', t.id===id ? 'true':'false'));
    panels.forEach(p=> p.setAttribute('aria-hidden', p.id.replace('panel','tab')!==id));
    if (window.__REPLOT) window.__REPLOT();
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> show(t.id)));
  show('tab-comp');
})();
let rT=null; window.__REPLOT=()=>{ clearTimeout(rT); rT=setTimeout(()=>{ if (!lastMetrics) return; drawCharts(lastMetrics); }, 80); };
new ResizeObserver(()=> window.__REPLOT()).observe(document.body);

/* ======= Controls ======= */
document.getElementById('tblApply')?.addEventListener('click', ()=>{ page=1; loadTable(); });
byId('applyFilters')?.addEventListener('click', ()=>{ page=1; loadAll(); loadRecent(); syncExport(); });
byId('resetFilters')?.addEventListener('click', ()=>{
  fCampus.value=''; fAY.value=''; fTerm.value=''; fProgram.value=''; fType.value=''; fMinConf.value='0'; fDays.value='30';
  byId('globalSearch').value=''; page=1; loadAll(); loadRecent(); syncExport();
});
byId('denseRows')?.addEventListener('change', e=>{ document.getElementById('topTable').classList.toggle('dense', e.target.checked); document.getElementById('recentTable').classList.toggle('dense', e.target.checked); });
byId('exportClientCsv')?.addEventListener('click', exportVisibleCsv);
byId('globalSearch')?.addEventListener('input', ()=> renderTable(applyClientSearch(latestRows)));

prevPage.addEventListener('click', ()=>{ if(page>1){ page--; loadTable(); }});
nextPage.addEventListener('click', ()=>{ const size=Number(tblSize.value||25); const pages=Math.max(1,Math.ceil(total/size)); if(page<pages){ page++; loadTable(); }});

/* ======= CSV export (visible rows only) ======= */
function exportVisibleCsv(){
  if(!latestRows||!latestRows.length){ alert('No rows to export.'); return; }
  const header=['bucket','priority','prob','conf','first_program','student_type','curr_region','created_at'];
  const lines=[header.join(',')];
  latestRows.forEach(r=>{
    const b=bucketOf(r.prob||0).label;
    const row=[b,(r.priority||0).toFixed(4),(r.prob||0).toFixed(4),(r.conf||0).toFixed(4),
      `"${(r.first_program||'').replace(/"/g,'""')}"` ,`"${(r.student_type||'').replace(/"/g,'""')}"`,
      `"${(r.curr_region||'').replace(/"/g,'""')}"`,`"${fmtDate(r.created_at)}"`];
    lines.push(row.join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='sage-visible.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function syncExport(){
  const f=readFilters();
  const qs=new URLSearchParams({ days:f.days, min_conf:f.min_conf, sort:f.sort, dir:f.dir, page_size:f.page_size });
  if(f.program)qs.set('program',f.program); if(f.region)qs.set('region',f.region);
  byId('exportCsv').href=fullUrl('/api/admin/export.csv?'+qs.toString());
}

/* ======= Help + keyboard ======= */
const help=byId('help'); const helpBtn=byId('helpBtn'); const helpClose=byId('helpClose');
function toggleHelp(on){ help.classList.toggle('open', on ?? !help.classList.contains('open')); (on ?? help.classList.contains('open')) && helpClose.focus(); }
helpBtn.addEventListener('click', ()=> toggleHelp(true));
helpClose.addEventListener('click', ()=> toggleHelp(false));
help.addEventListener('click', (e)=>{ if(e.target===help) toggleHelp(false); });
document.addEventListener('keydown', (e)=>{
  if(e.key==='/'){ e.preventDefault(); byId('globalSearch').focus(); }
  if(e.key==='r'){ e.preventDefault(); loadAll(); loadRecent(); toast('Refreshingâ€¦', 1200); }
  if(e.key==='?'){ e.preventDefault(); toggleHelp(); }
  if(e.key===']'){ e.preventDefault(); nextPage.click(); }
  if(e.key==='['){ e.preventDefault(); prevPage.click(); }
  if(e.key==='g'){ let first=true; const h=(ev)=>{ if(ev.key==='g' && first){ first=false; window.scrollTo({top:0,behavior:'smooth'}); document.removeEventListener('keydown',h); } }; document.addEventListener('keydown',h); }
});

/* ======= Network indicator ======= */
const netDot=byId('netDot');
window.addEventListener('online', ()=>{ netDot.style.background='#22c55e'; netDot.title='Network OK'; });
window.addEventListener('offline', ()=>{ netDot.style.background='#f97316'; netDot.title='Offline'; toast('Offline. Showing cached view if available.', 4000); });

/* ======= Boot ======= */
async function loadAll(){
  announce('Loading dashboard'); lastUpdated.textContent='Loadingâ€¦';
  try{
    const m = await getJSON(buildQS('/api/admin/metrics'),'metrics');
    if(!m.ok){ lastUpdated.textContent='Error loading metrics'; toast('Metrics failed to load', 3500); return; }
    lastMetrics=m; drawAll(m);
    page=1; await loadTable();
    lastUpdated.textContent='Last updated: '+new Date().toLocaleString();
    announce('Dashboard updated');
  }catch(e){
    lastUpdated.textContent='Failed to load metrics';
    toast('Failed to load metrics', 3500);
  }
}
loadAll();
loadRecent();
syncExport();
</script>
</body>
</html>
