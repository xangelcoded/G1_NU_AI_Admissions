{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Poppins:wght@700;800;900&display=swap" rel="stylesheet" />

<style>
  /* ===== NU Cyberpunk Tokens ===== */
  :root{
    --ink:hsl(231 22% 92%); --muted:hsl(231 14% 72%);
    --nu-blue:#0b3d91; --nu-blue-700:#0a2f70;
    --neon-cyan:#28E1FF; --neon-violet:#9B5CFF; --neon-pink:#FF4D9D; --neon-lime:#B0FF49;
    --gold-500:#FFD86B; --gold-700:#D9B23C;
    --bg:hsl(231 66% 6%); --surface:hsl(231 60% 10%/.72); --panel:hsl(231 60% 12%/.86);
    --ring:hsl(192 100% 55%/.55);
    --border:1px solid hsl(0 0% 100%/.10);
    --radius-xl:28px; --radius-lg:22px; --radius-md:16px; --radius-sm:12px;
    --shadow-1:0 20px 50px hsl(231 64% 12%/.55), 0 8px 24px hsl(231 64% 8%/.35);
    --ease-1:cubic-bezier(.2,.8,.2,1);
  }
  [data-theme="light"]{
    --ink:hsl(233 28% 14%); --muted:hsl(233 12% 40%);
    --bg:hsl(225 35% 97%); --surface:hsl(0 0% 100%/.92); --panel:hsl(0 0% 100%/.96);
    --border:1px solid hsl(232 10% 10%/.08);
  }

  /* ===== Base ===== */
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;min-height:100svh;background:var(--bg);color:var(--ink);
       font:16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  h1,h2,h3{font-family:Poppins,Inter,system-ui,sans-serif;letter-spacing:.2px}
  a{color:inherit;text-decoration-thickness:2px;text-underline-offset:3px}
  :focus-visible{outline:3px solid var(--ring);outline-offset:2px;border-radius:10px}
  .container{width:min(1100px,92vw);margin-inline:auto}

  /* ===== Cinematic Background (uses your images) ===== */
  .bg-campus{
    position:fixed;inset:0;z-index:-4;
    background:
      linear-gradient(180deg, rgba(2,12,28,.65), rgba(2,12,28,.35)),
      url('{{ url_for("static", filename="images/bg/cc2.png") }}') center/cover no-repeat fixed;
  }
  /* Neon aurora overlay */
  .bg-aurora{
    position:fixed;inset:-10% -20%;z-index:-3;pointer-events:none;
    background:
      radial-gradient(50vmax 30vmax at 15% 15%, color-mix(in oklab, var(--gold-700) 34%, transparent) 0 40%, transparent 60%),
      radial-gradient(60vmax 36vmax at 85% 10%, color-mix(in oklab, var(--muted) 34%, transparent) 0 30%, transparent 60%),
      radial-gradient(70vmax 36vmax at 30% 90%, color-mix(in oklab, var(--nu-blue) 30%, transparent) 0 35%, transparent 65%);
    filter:saturate(130%) blur(26px); opacity:.92; animation:aurora 16s var(--ease-1) infinite alternate;
  }
  @keyframes aurora{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(-2%,2%,0) scale(1.02)}}

  /* Animated grid + scanline for cyber vibe */
  .bg-grid{
    position:fixed;inset:0;z-index:-2;pointer-events:none;opacity:.20;mix-blend-mode:screen;
    background:
      linear-gradient(transparent 95%, rgba(255,255,255,.35) 0) 0 0/100% 18px,
      linear-gradient(90deg, transparent 95%, rgba(255,255,255,.35) 0) 0 0/18px 100%;
  }
  .bg-scan{
    position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.06;mix-blend-mode:screen;
    background:repeating-linear-gradient(180deg, rgba(255,255,255,.16) 0 1px, transparent 1px 3px);
    animation:scan 8s linear infinite;
  }
  @keyframes scan{0%{transform:translateY(-10%)}100%{transform:translateY(10%)}}

  /* Subtle film grain */
  .grain{position:fixed;inset:-50%;z-index:-1;pointer-events:none;opacity:.06;mix-blend-mode:overlay;
    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".9" numOctaves="2"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity=".5"/></svg>') repeat 0 0/220px 220px}

  /* ===== Top bar ===== */
  .topbar{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(10px);
          background:linear-gradient(180deg, var(--surface), transparent);border-bottom:var(--border)}
  .top-in{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0}
  .brand{display:flex;align-items:center;gap:12px;text-decoration:none}
  .brand img{width:36px;height:36px;border-radius:10px;object-fit:cover;box-shadow:0 0 0 2px rgba(255,255,255,.08)}
  .brand .title{line-height:1.1}
  .title .a{font-weight:900;font-size:14px}
  .title .b{font-weight:800;font-size:12px;color:var(--muted)}
  .switch{display:flex;align-items:center;gap:6px;border:var(--border);border-radius:12px;background:var(--surface);padding:6px 10px}
  .switch button{background:none;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;color:var(--muted)}
  .switch button[aria-pressed="true"]{outline:2px solid var(--ring);color:var(--ink)}
  .switch svg{width:18px;height:18px}

  /* ===== Auth Card (Glass + holo edge + depth) ===== */
  .auth-wrap{display:grid;place-items:center;min-height:calc(100svh - 64px);padding:42px 0}
  .auth{
    width:min(600px,92vw);
    background:linear-gradient(180deg, var(--panel), color-mix(in lab, var(--panel), transparent 12%));
    border:var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-1);
    padding:24px;position:relative;overflow:hidden;transform-style:preserve-3d;will-change:transform;
  }
  /* Holographic border glow */
  .auth::before{
    content:"";position:absolute;inset:-1px;border-radius:inherit;pointer-events:none;
    background:
      conic-gradient(from 180deg at 50% 50%,
      transparent 0 13%, color-mix(in lab, var(--muted), transparent 60%) 14% 24%,
      transparent 25% 49%, color-mix(in lab, var(--gold-700), transparent 58%) 50% 60%,
      transparent 61% 74%, color-mix(in lab, var(--nu-blue), transparent 58%) 75% 85%,
      transparent 86% 100%);
    filter:blur(10px) saturate(140%); opacity:.55; mask:linear-gradient(#000 0 0) padding-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;
  }
  /* Angle accents */
  .accent{position:absolute;inset:auto 22px 22px auto;width:140px;height:140px;pointer-events:none;
    background:conic-gradient(from -45deg, transparent 0 70%, rgba(255,255,255,.08) 70% 100%);
    border-radius:22px;filter:blur(8px);opacity:.5;transform:rotate(6deg);
  }

  .auth-head{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .auth-head img{width:44px;height:44px;border-radius:12px;object-fit:cover;box-shadow:0 0 0 2px rgba(255,255,255,.08)}
  .auth h2{margin:.2em 0 .1em;font-weight:900}
  .auth p.sub{margin:0;color:var(--muted);font-weight:700}

  /* Flashed messages */
  .alert{margin:12px 0 0;padding:10px 12px;border-radius:12px;border:1px solid hsl(0 0% 50%/.2);
    background:hsl(231 20% 10%/.10);font-weight:800}
  .alert[data-cat="success"]{border-color:hsl(142 76% 38%/.35);background:hsl(142 76% 20%/.15)}
  .alert[data-cat="error"],.alert[data-cat="danger"]{border-color:hsl(0 75% 45%/.35);background:hsl(0 75% 20%/.15)}

  /* ===== Fields ===== */
  form.auth-form{display:grid;gap:14px;margin-top:14px}
  .field{display:grid;gap:6px}
  .field label{font-weight:900;letter-spacing:.2px}
  .control{
    display:grid;grid-template-columns:1fr auto;align-items:center;
    border:1px solid hsl(0 0% 100%/.14);
    background:linear-gradient(180deg, transparent, transparent);
    border-radius:14px;padding:6px 6px 6px 10px;
    transition:border-color .15s var(--ease-1), box-shadow .15s var(--ease-1), transform .15s var(--ease-1);
  }
  .control:focus-within{box-shadow:0 0 0 4px var(--ring); border-color:color-mix(in lab, var(--muted), white 20%); transform:translateY(-1px)}
  .control input{border:0;background:transparent;color:var(--ink);padding:12px 8px;font-weight:800;outline:none}
  .control button.icon{background:transparent;border:0;border-left:1px solid hsl(0 0% 100%/.14);
    padding:10px 10px;border-radius:0 12px 12px 0;cursor:pointer;color:var(--muted)}
  .hint{color:var(--muted);font-size:12px}
  .caps{display:none;color:#ef4444;font-weight:900;font-size:12px}

  /* Password meter (visual only) */
  .meter{height:6px;border-radius:999px;background:hsl(0 0% 100%/.08);overflow:hidden}
  .meter > span{display:block;height:100%;width:0%;background:linear-gradient(90deg, #ff5a7a, #ffd86b, #28e1ff);transition:width .25s var(--ease-1)}

  /* Row */
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .row a{text-decoration:none;color:var(--muted)}
  .row a:hover{color:var(--ink)}

  /* Buttons */
  .btn{--_start:var(--gold-500);--_end:var(--gold-700);--_text:#141826;--_ring:var(--ring);
       display:inline-flex;align-items:center;justify-content:center;gap:10px;text-decoration:none;border:0;
       padding:13px 16px;border-radius:var(--radius-md);font-weight:900;letter-spacing:.2px;
       background:linear-gradient(180deg,var(--_start),var(--_end));color:var(--_text);
       box-shadow:0 10px 28px hsl(47 90% 50%/.28), 0 3px 10px hsl(47 90% 30%/.18);
       transform:translateY(0);transition:transform .15s var(--ease-1), box-shadow .2s var(--ease-1)}
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn:focus-visible{outline:0;box-shadow:0 0 0 4px var(--_ring), var(--shadow-1)}
  .btn-outline{background:var(--surface);border:var(--border);color:var(--ink);box-shadow:none}

  .actions{display:grid;gap:12px}
  .or{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;color:var(--muted);font-weight:900}
  .or::before,.or::after{content:"";height:1px;background:linear-gradient(90deg,transparent, hsl(0 0% 100%/.25), transparent)}

  .sso{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:540px){.sso{grid-template-columns:1fr}}
  .sso a{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:12px;border:var(--border);
    background:var(--surface);text-decoration:none;font-weight:900}
  .sso img{filter:drop-shadow(0 0 0 rgba(0,0,0,0))}

  /* Top progress shimmer on submit */
  .progress{position:absolute;left:0;right:0;top:0;height:3px;overflow:hidden;border-radius:inherit;display:none}
  .progress.active{display:block}
  .progress span{position:absolute;inset:0;background:
      linear-gradient(90deg, transparent, var(--muted), var(--nu-blue), transparent);
      animation:line 1.2s linear infinite}
  @keyframes line{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

  @media (prefers-reduced-motion:reduce){.bg-aurora{animation:none}.bg-scan{animation:none}}
</style>

<meta name="theme-color" content="#0a122e" id="metaTheme"/>

<!-- Background stacks (uses your campus image) -->
<div class="bg-campus" aria-hidden="true"></div>
<div class="bg-aurora" aria-hidden="true"></div>
<div class="bg-grid" aria-hidden="true"></div>
<div class="bg-scan" aria-hidden="true"></div>
<div class="grain" aria-hidden="true"></div>

<header class="topbar">
  <div class="container top-in">
    <!-- Avoid BuildError: use an existing endpoint -->
    <a class="brand" href="{{ url_for('view.index') }}" aria-label="Back to Dashboard">
      <img src="{{ url_for('static', filename='images/logos/nu-lipa.png') }}" alt="" onerror="this.style.display='none'">
      <div class="title"><div class="a">NU Lipa</div><div class="b">NU Quest</div></div>
    </a>
    <div class="switch" id="themeSwitch" role="group" aria-label="Theme">
      <button type="button" data-mode="auto"  aria-pressed="true"  title="Auto">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M3 12h2M19 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      </button>
      <button type="button" data-mode="light" aria-pressed="false" title="Light">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="5.2" stroke="currentColor" stroke-width="1.8"/><g stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M3 12h2M19 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></g></svg>
      </button>
      <button type="button" data-mode="dark"  aria-pressed="false" title="Dark">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 12.39A8 8 0 1 1 11.61 4 6 6 0 0 0 20 12.39Z" stroke="currentColor" stroke-width="1.8"/></svg>
      </button>
    </div>
  </div>
</header>

<main class="auth-wrap container" role="main" aria-label="Admin login">
  <section class="auth" aria-labelledby="loginTitle" id="authCard">
    <div class="accent" aria-hidden="true"></div>
    <div class="progress" id="progress"><span></span></div>

    <div class="auth-head">
      <img src="{{ url_for('static', filename='images/logos/bulldog.png') }}" alt="" onerror="this.style.display='none'">
      <div>
        <h2 id="loginTitle">Admin Login</h2>
        <p class="sub">Secure access to NU Quest admin</p>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="alert" data-cat="{{ cat|lower }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Backend unchanged: POST /login with same field names -->
    <form class="auth-form" method="post" novalidate id="loginForm">
      <div class="field">
        <label for="email">Email</label>
        <div class="control">
          <input id="email" name="email" type="email" inputmode="email" autocomplete="username" required placeholder="you@nu-lipa.edu.ph" />
          <button class="icon" type="button" aria-hidden="true" tabindex="-1" title="Email">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true"><path d="M4 8l8 5 8-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" stroke-width="1.8"/></svg>
          </button>
        </div>
        <span class="hint">Use your registered admin email.</span>
      </div>

      <div class="field">
        <label for="password">Password</label>
        <div class="control">
          <input id="password" name="password" type="password" autocomplete="current-password" required />
          <button id="togglePw" class="icon" type="button" aria-label="Show password">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="currentColor" stroke-width="1.8"/><circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/></svg>
          </button>
        </div>
        <div class="meter" aria-hidden="true"><span id="pwMeter"></span></div>
        <span class="caps" id="capsHint">Caps Lock is ON</span>
      </div>

      <div class="row">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" name="remember" value="1" /> <span>Remember me</span>
        </label>
        <a href="#" aria-label="Forgot your password?">Forgot password?</a>
      </div>

      <div class="actions">
        <button id="submitBtn" class="btn" type="submit">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Sign in
        </button>
        <div class="or">or</div>
        <div class="sso">
          <!-- Use your existing icons/images -->
          <a href="#"><img src="{{ url_for('static', filename='images/icons/google.png') }}" alt="" width="18" height="18" loading="lazy" onerror="this.style.display='none'"> Continue with Google</a>
          <a href="#"><img src="{{ url_for('static', filename='images/icons/microsoft.png') }}" alt="" width="18" height="18" loading="lazy" onerror="this.style.display='none'"> Continue with Microsoft 365</a>
        </div>
      </div>

      <div class="footer-links" style="text-align:center;margin-top:10px;color:var(--muted)">
        <a href="{{ url_for('view.index') }}">← Back to Dashboard</a>
      </div>
    </form>
  </section>
</main>

<noscript>
  <div class="container" style="margin:12px auto 24px; padding:12px 16px; border-radius:12px; border:1px solid #ccc; background:#fff; color:#111">
    JavaScript is disabled. You can still log in, but theme switching and small UX helpers are off.
  </div>
</noscript>
{% endblock %}

{% block scripts %}
<script>
  /* Theme switcher (auto/light/dark) */
  (function(){
    const root = document.body, metaTheme = document.getElementById('metaTheme');
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    const switcher = document.getElementById('themeSwitch');
    const KEY='nu_theme_mode';
    const prefersDark = () => mq.matches;
    function apply(mode){
      const finalMode = (mode==='auto') ? (prefersDark()? 'dark' : 'light') : mode;
      root.setAttribute('data-theme', finalMode);
      document.documentElement.style.colorScheme = finalMode;
      metaTheme?.setAttribute('content', finalMode==='dark' ? '#0a122e' : '#ffffff');
      switcher?.querySelectorAll('button[data-mode]').forEach(b=>b.setAttribute('aria-pressed', String(b.dataset.mode===mode)));
    }
    function setMode(m){ localStorage.setItem(KEY,m); apply(m); }
    const saved = ['auto','light','dark'].includes(localStorage.getItem(KEY)) ? localStorage.getItem(KEY) : 'auto';
    apply(saved);
    mq.addEventListener?.('change', ()=>{ if((localStorage.getItem(KEY)||'auto')==='auto') apply('auto'); });
    switcher?.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-mode]'); if(!btn) return;
      e.preventDefault(); e.stopPropagation(); setMode(btn.dataset.mode);
    });
  })();

  /* Subtle 3D tilt (purely visual) */
  (function(){
    const card = document.getElementById('authCard');
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (!card || prefersReduced) return;
    let rx=0, ry=0;
    card.addEventListener('pointermove', (e)=>{
      const r = card.getBoundingClientRect();
      const cx = r.left + r.width/2, cy = r.top + r.height/2;
      const dx = (e.clientX - cx)/r.width, dy = (e.clientY - cy)/r.height;
      rx = dy * -6; ry = dx * 10;
      card.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(0)`;
    });
    card.addEventListener('pointerleave', ()=>{ card.style.transform = 'none'; });
  })();

  /* Password helpers (visual only; backend unchanged) */
  (function(){
    const pw = document.getElementById('password');
    const meter = document.getElementById('pwMeter');
    const caps = document.getElementById('capsHint');
    const toggle = document.getElementById('togglePw');

    function score(v){
      if(!v) return 0;
      let s = Math.min(10, v.length);
      s += /[A-Z]/.test(v) ? 3 : 0;
      s += /[a-z]/.test(v) ? 2 : 0;
      s += /\d/.test(v) ? 2 : 0;
      s += /[^A-Za-z0-9]/.test(v) ? 3 : 0;
      return Math.min(20, s) * 5; // 0–100
    }
    pw?.addEventListener('input', ()=>{
      meter.style.width = score(pw.value) + '%';
    });
    function capsUpdate(e){
      const on = e.getModifierState && e.getModifierState('CapsLock');
      caps.style.display = on ? 'inline' : 'none';
    }
    pw?.addEventListener('keydown', capsUpdate);
    pw?.addEventListener('keyup', capsUpdate);
    toggle?.addEventListener('click', ()=>{
      const show = pw.type === 'password';
      pw.type = show ? 'text' : 'password';
      toggle.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
      pw.focus();
    });
  })();

  /* Submit: disable button + top shimmer; let backend handle POST /login */
  (function(){
    const form = document.getElementById('loginForm');
    const btn = document.getElementById('submitBtn');
    const bar = document.getElementById('progress');
    form?.addEventListener('submit', ()=>{
      btn.disabled = true; btn.setAttribute('aria-busy','true');
      btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" opacity=".35"></circle><path d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="2"></path></svg> Signing in…';
      bar?.classList.add('active');
    });
  })();

  /* Parallax on aurora layer (background image remains) */
  (function(){
    const bg = document.querySelector('.bg-aurora'); if(!bg) return;
    const onScroll = () => { const y = Math.round(window.scrollY * 0.15); bg.style.transform = `translate3d(0,${-y}px,0)`; };
    addEventListener('scroll', onScroll, { passive: true }); onScroll();
  })();
</script>
{% endblock %}
